name: Build EZ Theme

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      panel_type:
        description: 'Panel Type'
        required: true
        default: 'Xiao-V2board'
        type: choice
        options:
        - Xiao-V2board
        - V2board
        - SSPanel
      site_name:
        description: 'Site Name'
        required: true
        default: 'EZ Theme'
        type: string
      site_description:
        description: 'Site Description'
        required: false
        default: '专业的主题生成服务'
        type: string
      api_url:
        description: 'API URL'
        required: true
        default: 'https://your-panel.com'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        # 检查 base-build 目录是否存在
        if [ -d "base-build" ]; then
          cd base-build
          npm install
        else
          echo "base-build directory not found, skipping..."
        fi
        
    - name: Build theme
      run: |
        if [ -d "base-build" ]; then
          cd base-build
          npm run build
        else
          echo "Creating simple theme build..."
          mkdir -p dist
          echo "<!DOCTYPE html><html><head><title>EZ Theme</title></head><body><h1>EZ Theme</h1><p>Built with GitHub Actions</p></body></html>" > dist/index.html
        fi
      env:
        NODE_OPTIONS: '--max-old-space-size=8192'
        
    - name: Create config file
      run: |
        if [ -d "base-build" ]; then
          mkdir -p base-build/dist/config
          cat > base-build/dist/config/index.js << 'EOF'
        else
          mkdir -p dist/config
          cat > dist/config/index.js << 'EOF'
        fi
        export const config = {
          PANEL_TYPE: '${{ github.event.inputs.panel_type || 'Xiao-V2board' }}',
          SITE_CONFIG: {
            siteName: '${{ github.event.inputs.site_name || 'EZ Theme' }}',
            siteDescription: '${{ github.event.inputs.site_description || '专业的主题生成服务' }}'
          },
          API_CONFIG: {
            baseURL: '${{ github.event.inputs.api_url || 'https://your-panel.com' }}'
          }
        };
        window.EZ_CONFIG = config;
        EOF
        
    - name: Create ZIP file
      run: |
        if [ -d "base-build/dist" ]; then
          cd base-build/dist
        else
          cd dist
        fi
        zip -r ../../theme-build.zip .
        
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: theme-build
        path: theme-build.zip
        
    - name: Create release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: theme-build.zip
        tag_name: v${{ github.run_number }}
        name: EZ Theme Build v${{ github.run_number }}
        body: |
          ## EZ Theme 构建版本
          
          **面板类型:** ${{ github.event.inputs.panel_type || 'Xiao-V2board' }}
          **网站名称:** ${{ github.event.inputs.site_name || 'EZ Theme' }}
          **API地址:** ${{ github.event.inputs.api_url || 'https://your-panel.com' }}
          
          ### 使用方法
          1. 下载 ZIP 文件
          2. 解压到你的网站根目录
          3. 配置你的 API 地址
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
